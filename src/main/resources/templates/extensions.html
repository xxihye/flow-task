<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>확장자 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body class="p-4">
<h3>파일 확장자 차단 관리</h3>
<div class="container">
    <div class="row align-items-start mb-2">
        <div class="col-2">
            <span class="label-small-bold">고정 확장자:</span>
        </div>
        <div class="col-10">
            <div class="d-flex flex-wrap gap-3 form-check-group" id="fixedExtensionContainer"></div>
        </div>
    </div>
    <div class="row align-items-center mb-2">
        <div class="col-2">
            <span class="label-small-bold">커스텀 확장자:</span>
        </div>
        <div class="col-10 d-flex align-items-center gap-2">
            <form id="extensionForm" class="d-flex align-items-center gap-2">
                <input type="text" id="extensionInput" class="form-control form-control-sm w-auto"
                       maxlength="20" required pattern="[a-zA-Z]{1,20}" title="영문자만 입력 가능. (최대 20자)"
                       placeholder="확장자 입력"/>
                <button type="submit" class="btn btn-sm btn-secondary">+ 추가</button>
            </form>
        </div>
    </div>
    <div class="row">
        <div class="col-2"></div>
        <div class="col-10">
            <div class="badge-box">
                <div class="text-muted small mb-2">
                    <span id="badge-count">0</span><span>/200</span>
                </div>
                <div class="d-flex flex-wrap gap-2" id="badgeContainer"></div>
            </div>
        </div>
    </div>
</div>
<!-- 고정 확장자 체크박스 템플릿 -->
<div id="checkbox-template" style="display:none;">
    <div class="form-check">
        <input class="form-check-input fixed-extension-checkbox" type="checkbox" name="fixedExtensions" value="">
        <label class="form-check-label" for="">확장자</label>
    </div>
</div>
<!-- 커스텀 확장자 배지 템플릿 -->
<div id="badge-template" style="display:none;">
    <div>
        <span class="badge bg-primary badge-item" id="">
          <span class="extension-text"></span>
          <button type="button" class="btn-close btn-close-white btn-sm ms-2 remove-btn" aria-label="Remove"></button>
        </span>
    </div>
</div>
<!-- 에러 토스트 -->
<div class="position-fixed top-50 start-50 translate-middle p-3" style="z-index: 1100;">
    <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive"
         aria-atomic="true" data-bs-autohide="true" data-bs-delay="1000">
        <div class="d-flex">
            <div class="toast-body">
                오류가 발생했습니다.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
        </div>
    </div>
</div>
<!-- 성공 토스트 -->
<div class="position-fixed top-50 start-50 translate-middle p-3" style="z-index: 1100;">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="polite"
         aria-atomic="true" data-bs-autohide="true" data-bs-delay="1000">
        <div class="d-flex">
            <div class="toast-body">
                성공했습니다.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(function () {
        //확장자 리스트 조회 및 세팅
        axios.get('/api/extensions')
            .then(response => {
                const data = response.data;
                const fixedExtensions = data.fixedExtensions || [];
                const customExtensions = data.customExtensions || [];

                // 고정 확장자 체크박스 렌더링
                const $fixedContainer = $('#fixedExtensionContainer');
                const $checkboxTemplate = $('#checkbox-template > div').clone();

                $fixedContainer.empty();

                fixedExtensions.forEach(ext => {
                    const $checkbox = $checkboxTemplate.clone();
                    const id = `check-${ext.id}`;

                    $checkbox.find('input.form-check-input').attr('id', id).val(ext.extension).prop('checked', ext.isUsed);
                    $checkbox.find('label.form-check-label').attr('for', id).text(ext.extension);
                    $fixedContainer.append($checkbox);
                });

                // 커스텀 확장자 배지 렌더링
                const $badgeContainer = $('#badgeContainer');
                const $template = $('#badge-template > div').clone();

                $badgeContainer.empty();

                customExtensions.forEach(ext => {
                    const $badge = $template.clone();

                    $badge.find('.badge-item').attr('id', `badge-${ext.id}`);
                    $badge.find('.extension-text').text(ext.extension);
                    $badgeContainer.append($badge);
                });

                // 커스텀 확장자 개수 업데이트
                $('#badge-count').text(customExtensions.length);

            }).catch(err => {
            console.error('요청 실패:', err);

            const errorMessage = err.response?.data?.message || '오류가 발생했습니다.';
            $('#errorToast .toast-body').text(errorMessage);

            const toastEl = $('#errorToast');
            const toast = new bootstrap.Toast(toastEl[0]);
            toast.show();
        });
    });

    /* 고정 확장자 수정 */
    $(document).on('change', '.fixed-extension-checkbox', function () {
        const $checkbox = $(this);
        const id = $checkbox.attr('id').split('-')[1];
        const isUsed = $checkbox.is(':checked');

        axios.patch('/api/extensions/fixed', {
            id: Number(id),
            isUsed: isUsed
        })
            .then(() => {
                const $toastBody = $('#successToast .toast-body');
                $toastBody.text('수정되었습니다.');

                const toastEl = $('#successToast');
                const toast = new bootstrap.Toast(toastEl[0]);

                toast.show();
            })
            .catch((err) => {
                const errorMessage = err.response?.data?.message || '오류가 발생했습니다.';
                $('#errorToast .toast-body').text(errorMessage);
                const toast = new bootstrap.Toast($('#errorToast'));
                toast.show();

                // 실패 시 체크박스 상태 복구
                $checkbox.prop('checked', !isUsed);
            });
    });

    /* 커스텀 확장자 추가 */
    $(document).on('submit', '#extensionForm', function (e) {
        e.preventDefault();

        const extension = $('#extensionInput').val().trim();

        //입력에 대한 유효성 검증
        if (!/^[a-zA-Z]{1,20}$/.test(extension)) {
            $('#extensionInput').addClass('is-invalid');
            return;
        }

        $('#extensionInput').removeClass('is-invalid');

        const count = Number($("#badge-count").text());

        //최대 개수 200 제한
        if(count == 200){
            const errorMessage = '확장자 등록은 200개까지 가능합니다';
            $('#errorToast .toast-body').text(errorMessage);

            const toastEl = $('#errorToast');
            const toast = new bootstrap.Toast(toastEl[0]);
            toast.show();
        }

        axios.post('/api/extensions/custom', {extension})
            .then((res) => {
                const newExt = res.data;
                const $newBadge = $('#badge-template > div').clone().removeAttr('id');
                const count = Number($('#badge-count').text());

                $newBadge.find('span.badge').attr('id', 'badge-' + newExt.id);
                $newBadge.find('.extension-text').text(newExt.extension);

                $('#badgeContainer').append($newBadge);
                $('#extensionInput').val('');
                $('#badge-count').text(count + 1);
            })
            .catch(err => {
                console.error('요청 실패:', err);

                const errorMessage = err.response?.data?.message || '오류가 발생했습니다.';
                $('#errorToast .toast-body').text(errorMessage);

                const toastEl = $('#errorToast');
                const toast = new bootstrap.Toast(toastEl[0]);
                toast.show();
            });
    });

    /* 커스텀 확장자 삭제 */
    $(document).on('click', '.remove-btn', function () {
        const $badgeItem = $(this).closest('.badge-item');
        const $badgeDiv = $(this).closest('div');
        const extensionId = $badgeItem.attr('id').split('-')[1];
        const $badgeCount = $("#badge-count");

        axios.delete(`/api/extensions/custom/${extensionId}`)
            .then(() => {
                $badgeDiv.remove();
                $badgeCount.text($badgeCount.text() - 1);
            })
            .catch(err => {
                console.error('요청 실패:', err);

                const errorMessage = err.response?.data?.message || '오류가 발생했습니다.';
                $('#errorToast .toast-body').text(errorMessage);

                const toast = new bootstrap.Toast($('#errorToast'));
                toast.show();
            });
    });
</script>
</body>
</html>